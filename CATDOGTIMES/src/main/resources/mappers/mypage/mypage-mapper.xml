<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >

<mapper namespace="com.catdog.times.mypage.model.mapper.MypageMapper">

	<resultMap id="myPageResultMap" type="MypageDTO">
		<result column="MEMBER_NO" property="memberNo"/>
		<result column="MEMBER_ID" property="memberId"/>
		<result column="MEMBER_PW" property="memberPw"/>
		<result column="MEMBER_NAME" property="memberName"/>
		<result column="MEMBER_GENDER" property="memberGender"/>
		<result column="MEMBER_NICKNAME" property="memberNickname"/>
		<result column="MEMBER_EMAIL" property="memberEmail"/>
		<result column="MEMBER_IS" property="memberIs"/>
		<result column="MEMBER_TYPE" property="memberType"/>
		<result column="MEMBER_WARN" property="memberWarn"/>
		<result column="MEMBER_CREATE_DATE" property="memberCreateDate"/>
		<result column="MODIFY_DATE" property="modifyDate"/>
		<result column="MEMBER_PHOTO" property="memberPhoto"/>
		<result column="MEMBER_ADDRESS" property="memberAddress"/>
		<result column="MEMBER_ZIPCODE" property="memberZipcode"/>
		<result column="MEMBER_DETAIL_ADDRESS" property="memberDetailAddress"/>
		<result column="MEMBER_SNS_ID" property="memberSnsId"/>
		
		<result column="POST_TOTAL" property="postTotal"/>
		<result column="FOLLOWER_CNT" property="followerCnt"/>
		<result column="FOLLOWING_CNT" property="followingCnt"/>
	</resultMap>

	<resultMap id="postContentResultMap" type="PostContentDTO">
		<result column="POST_ID" property="postId"/>
		<result column="POST_CONTENT" property="postContent"/>
		<result column="POST_CREATE_DATE" property="postCreateDate"/>
		<result column="POST_UPDATE_DATE" property="postUpdateDate"/>
		<result column="MEMBER_NO" property="memberNo"/>
	</resultMap>
	
	<select id="findByID" resultMap="myPageResultMap" parameterType="String">
		SELECT M.MEMBER_NO
		     , M.MEMBER_ID
		     , M.MEMBER_PW
		     , M.MEMBER_NAME
		     , M.MEMBER_GENDER
		     , M.MEMBER_NICKNAME
		     , M.MEMBER_EMAIL
		     , M.MEMBER_IS
		     , M.MEMBER_TYPE
		     , M.MEMBER_WARN
		     , M.MEMBER_CREATE_DATE
		     , M.MODIFY_DATE
		     , NVL(M.MEMBER_PHOTO,'undefined.jpg')       AS MEMBER_PHOTO
		     , M.MEMBER_ADDRESS
		     , M.MEMBER_ZIPCODE
		     , M.MEMBER_DETAIL_ADDRESS
		     , M.MEMBER_SNS_ID
		     , (SELECT COUNT(POST_ID)
                  FROM POST P
                 WHERE P.MEMBER_NO = M.MEMBER_NO ) AS POST_TOTAL 
             , (SELECT  COUNT(FOLLOWER_ID)   
                  FROM FOLLOW F
                 WHERE F.MEMBER_NO = M.MEMBER_NO ) AS FOLLOWER_CNT
             , (SELECT  COUNT(FOLLOWING_ID)   
                  FROM FOLLOW F 
                 WHERE F.MEMBER_NO = M.MEMBER_NO ) AS FOLLOWING_CNT             
                 
		FROM MEMBER M
		WHERE M.MEMBER_ID = #{memberId}	
	</select>
	
	<select id="selectPostContent" resultMap="postContentResultMap" parameterType="Map">
		SELECT POST_ID
     		 , POST_CONTENT
     	 	 , POST_CREATE_DATE
     		 , POST_UPDATE_DATE
     		 , MEMBER_NO
  		 FROM POST 
  		WHERE 1=1	 
	  <choose>
    	<when test="searchType != null and searchType == 'postlike' ">
    	  AND POST_ID IN (SELECT POST_ID 
                    	    FROM POST_LIKE 
                           WHERE MEMBER_NO = #{memberNo} )
    	</when>
        <when test="searchType != null and searchType == 'bookmark' ">
		  AND POST_ID IN (SELECT POST_ID 
                   		    FROM BOOKMARK 
                   		   WHERE MEMBER_NO = #{memberNo} ) 
        </when>
        <otherwise>
          AND MEMBER_NO = #{memberNo} 
        </otherwise>
      </choose>
	</select>
	
	
	<update id="updateMemberInfo" parameterType="MypageDTO">
		UPDATE MEMBER
		SET
			MEMBER_PW = NVL(#{memberPw}, MEMBER_PW),
			MEMBER_NAME = NVL(#{memberName},MEMBER_NAME),
			MEMBER_GENDER = NVL(#{memberGender},MEMBER_GENDER),
			MEMBER_NICKNAME = NVL(#{memberNickname},MEMBER_NICKNAME),
			MEMBER_EMAIL = NVL(#{memberEmail},MEMBER_EMAIL),
			MEMBER_PHOTO = NVL(#{memberPhoto},MEMBER_PHOTO),
			MEMBER_ADDRESS = NVL(#{memberAddress},MEMBER_ADDRESS),
			MODIFY_DATE = SYSDATE
		WHERE
			MEMBER_NO = #{memberNo}
	</update>
		
	

</mapper>